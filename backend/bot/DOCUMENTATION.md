# 📚 Полная документация Telegram бота для событий

## 📋 Оглавление

1. [Описание проекта](#описание-проекта)
2. [Архитектура бота](#архитектура-бота)
3. [Структура проекта](#структура-проекта)
4. [Установка и настройка](#установка-и-настройка)
5. [Запуск бота](#запуск-бота)
6. [Режимы работы](#режимы-работы)
7. [Local API](#local-api)
8. [Команды бота](#команды-бота)
9. [Фильтры и функции](#фильтры-и-функции)
10. [Источники данных](#источники-данных)
11. [Частые проблемы](#частые-проблемы)

---

## 🎯 Описание проекта

**Telegram бот для уведомлений о ближайших событиях**

Бот предоставляет пользователям удобный доступ к информации о событиях (концерты, театры, выставки, спортивные мероприятия и т.д.) через Telegram. Поддерживает фильтрацию по типам событий, датам, цене, показывает детальную информацию и изображения.

### Основные возможности:

- ✅ Просмотр всех ближайших событий
- ✅ Фильтрация по типам событий (концерты, театры, выставки и т.д.)
- ✅ **Фильтрация по датам** (сегодня, завтра, неделя, месяц)
- ✅ **Фильтрация по цене** (бесплатно, до 500₽, 500-1500₽ и т.д.)
- ✅ **Пагинация** (по 5 событий на страницу)
- ✅ **Избранное** (сохранение любимых событий)
- ✅ Детальная информация о каждом событии (дата, место, цена, описание)
- ✅ Отображение изображений событий
- ✅ Локальный API для добавления событий
- ✅ Работает даже без подключения к основному бэкенду (моковые данные)
- ✅ Кэширование для быстрой работы
- ✅ Redis для избранного (сохранение между сессиями)

---

## 🏗 Архитектура бота

### Схема работы:

```
┌─────────────────────────────────────────────────────────┐
│                    Telegram Users                       │
│                   (пользователи)                        │
└────────────────────┬────────────────────────────────────┘
                     │
                     │ Telegram API (Webhook/Polling)
                     │
┌────────────────────▼────────────────────────────────────┐
│                   Bot Service (Monolith)                │
│  ┌──────────────────────────────────────────────────┐  │
│  │         Telegram Bot Handlers                    │  │
│  │  /start, /events, /types, /favorites, /help     │  │
│  │  Фильтры, пагинация, избранное                  │  │
│  └──────┬──────────────────────┬────────────────────┘  │
│         │                      │                        │
│  ┌──────▼──────────┐  ┌───────▼──────────────┐        │
│  │ Event Service   │  │ Favorites Service    │        │
│  │ - Получение     │  │ - Добавление/удаление│        │
│  │ - Фильтрация    │  │ - Получение списка   │        │
│  │ - Объединение   │  └───────┬──────────────┘        │
│  └──────┬──────────┘          │                        │
│         │                     │                        │
│  ┌──────▼─────────────────────▼──────────────────────┐ │
│  │         Local API (HTTP Server :3001)            │ │
│  │  - POST /events (добавление локальных событий)   │ │
│  │  - GET /events (получение локальных событий)    │ │
│  │  - DELETE /events/:uuid                         │ │
│  └──────────────────────────────────────────────────┘ │
│         │                                               │
│         │ Источники данных (приоритет сверху вниз)     │
│         │                                               │
│  ┌──────▼──────────┬──────────────┬──────────────┐    │
│  │ Local Events    │ Gateway API  │ Mock Data     │    │
│  │ (Redis + память)│ (внешний)    │ (fallback)    │    │
│  └──────┬──────────┴──────────────┴──────────────┘    │
│         │                                               │
└─────────┼───────────────────────────────────────────────┘
          │
┌─────────▼──────────────────────────────────────────────┐
│              Redis                                     │
│  - Кэш событий из Gateway (bot:cache:events:{type})   │
│  - Локальные события (bot:local-events)                │
│  - Избранное пользователей (bot:favorites:{userId})  │
└────────────────────────────────────────────────────────┘
```

### Поток данных:

1. **Пользователь** отправляет команду в Telegram
2. **Bot Handlers** обрабатывают команду
3. **Event Service** получает события из источников (в порядке приоритета):
   - Локальные события (добавленные через Local API)
   - Gateway API (основной бэкенд)
   - Моковые данные (fallback)
4. **Применение фильтров** (дата, цена, тип события)
5. **Пагинация** (разбиение на страницы)
6. **Форматирование** данных для Telegram
7. **Отправка** сообщений пользователю

### Приоритет источников данных:

```
1. Локальные события (Local API + Redis)  ← ВЫСШИЙ ПРИОРИТЕТ
2. Gateway API (основной бэкенд)
3. Моковые данные (встроенные в код)      ← FALLBACK
```

---

## 📁 Структура проекта

```
bot/
├── src/
│   ├── index.ts                 # Точка входа, инициализация
│   │
│   ├── handlers/
│   │   └── botHandlers.ts      # Обработчики команд Telegram
│   │                            # /start, /events, /types, /favorites, /help
│   │                            # Фильтры, пагинация, избранное
│   │
│   ├── services/
│   │   ├── eventService.ts     # Сервис для работы с событиями
│   │   │                        # Получение, фильтрация по датам/цене
│   │   │                        # Объединение источников
│   │   └── favoritesService.ts # Сервис для работы с избранным
│   │                            # Добавление/удаление в Redis
│   │
│   ├── api/
│   │   └── localApi.ts         # Локальный HTTP API
│   │                            # Добавление/удаление событий напрямую в бота
│   │
│   ├── core/
│   │   └── redis.ts            # Redis кэширование
│   │                            # Кэш событий и хранение локальных событий
│   │
│   ├── data/
│   │   └── mockEvents.ts       # Моковые данные (5 тестовых событий)
│   │                            # Используются как fallback
│   │
│   ├── types/
│   │   └── event.ts            # TypeScript типы и константы
│   │                            # Event, EventType, EVENT_TYPES и т.д.
│   │
│   └── utils/
│       ├── formatters.ts       # Форматирование сообщений для Telegram
│       │                        # Преобразование Event в текстовое сообщение
│       └── logger.ts           # Утилита для логирования (с поддержкой DEBUG)
│
├── package.json                 # Зависимости Node.js
├── tsconfig.json                # Настройки TypeScript
├── .env.example                 # Пример конфигурации
├── DOCUMENTATION.md             # Эта документация
```

---

## 🔧 Режимы работы

### Режим 1: Только моковые данные (без бэкенда)

**Настройка** (`bot/.env`):
```env
TELEGRAM_BOT_TOKEN=your_token
USE_MOCK_DATA=true
```

**Поведение**:
- Бот показывает только моковые данные (5 тестовых событий)
- Gateway API не используется
- Можно добавлять события через Local API
- Данные хранятся в памяти (пропадут при перезапуске, если нет Redis)

**Когда использовать**: Для тестирования, демонстрации, когда бэкенд недоступен

---

### Режим 2: С Gateway API, без Redis

**Настройка** (`bot/.env`):
```env
TELEGRAM_BOT_TOKEN=your_token
GATEWAY_URL=http://gateway:8000
USE_MOCK_DATA=false
```

**Поведение**:
- Получает события из Gateway API
- Нет кэширования (каждый запрос идет в API)
- Fallback на моковые данные при ошибках API
- Локальные события работают
- **Избранное работает только в памяти** (пропадет при перезапуске)

**Когда использовать**: Когда Redis недоступен, но нужен основной бэкенд

---

### Режим 3: Полная конфигурация (Gateway + Redis)

**Настройка** (`bot/.env`):
```env
TELEGRAM_BOT_TOKEN=your_token
GATEWAY_URL=http://gateway:8000
REDIS_URL=redis://redis:6379
CACHE_TTL_SECONDS=1800
USE_MOCK_DATA=false
```

**Поведение**:
- Получает события из Gateway API
- Кэширует результаты в Redis (30 минут по умолчанию)
- Локальные события сохраняются в Redis (не пропадают при перезапуске)
- **Избранное сохраняется в Redis** (сохраняется между сессиями)
- Fallback на моковые данные при ошибках

**Когда использовать**: Продакшен, когда нужна максимальная производительность и персистентность

---

## 🌐 Local API

Бот имеет встроенный HTTP API для добавления событий напрямую (без Gateway).

### Запуск

Local API автоматически запускается на порту 3001 (настраивается через `LOCAL_API_PORT`).

### Endpoints

#### `GET /health`
Проверка статуса API.

**Ответ**:
```json
{"status": "ok", "service": "bot-local-api"}
```

#### `GET /events`
Получить все локальные события.

**Ответ**: Массив событий
```json
[
  {
    "uuid": "...",
    "title": "...",
    "event_type": "concert",
    ...
  }
]
```

#### `GET /events/{type}`
Получить события по типу (concert, theater и т.д.).

#### `POST /events`
Добавить одно событие.

**Тело запроса**:
```json
{
  "uuid": "99999999-9999-9999-9999-999999999999",
  "title": "Мое событие",
  "event_type": "concert",
  "description": "Описание события",
  "price": 1500,
  "date_preview": "2024-12-25T18:00:00",
  "date_list": ["2024-12-25T18:00:00"],
  "place": "Концертный зал",
  "genre": "rock",
  "age": "18+",
  "image_url": "https://example.com/image.jpg",
  "url": "https://example.com/event"
}
```

**Ответ**:
```json
{
  "message": "Event added successfully",
  "uuid": "99999999-9999-9999-9999-999999999999",
  "event": { ... }
}
```

#### `POST /events/batch`
Добавить несколько событий.

**Тело запроса**:
```json
{
  "events": [
    { ... },
    { ... }
  ]
}
```

**Ответ**:
```json
{
  "created": ["uuid1", "uuid2"],
  "skipped": [{"uuid": "uuid3", "reason": "already_exists"}],
  "failed": []
}
```

#### `PUT /events/{uuid}`
Обновить событие.

#### `DELETE /events/{uuid}`
Удалить событие.

#### `GET /stats`
Статистика по событиям.

**Ответ**:
```json
{
  "total": 10,
  "by_type": {
    "concert": 5,
    "theater": 3,
    "exhibition": 2
  }
}
```

### Примеры использования

```bash
# Добавить событие
curl -X POST http://localhost:3001/events \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "99999999-9999-9999-9999-999999999999",
    "title": "Концерт",
    "event_type": "concert",
    "description": "Описание",
    "price": 1500,
    "date_preview": "2024-12-25T18:00:00",
    "date_list": ["2024-12-25T18:00:00"],
    "place": "Зал",
    "genre": "rock",
    "age": "18+",
    "image_url": "https://example.com/image.jpg",
    "url": "https://example.com/event"
  }'

# Получить все локальные события
curl http://localhost:3001/events

# Удалить событие
curl -X DELETE http://localhost:3001/events/99999999-9999-9999-9999-999999999999
```

**Важно**: 
- Если Redis доступен, локальные события сохраняются между перезапусками
- Если Redis недоступен, события хранятся только в памяти и пропадут при перезапуске

---

## 💬 Команды бота

### `/start`
Начало работы с ботом. Показывает приветственное сообщение и кнопки быстрого доступа:
- 📅 Все события
- 🔍 Выбрать тип
- ⭐ Избранное
- ⚙️ Фильтры

### `/events`
Показать все ближайшие события. Бот покажет список событий с краткой информацией и детали по каждому.

### `/types`
Показать кнопки с типами событий для фильтрации:
- 🎵 Концерты
- 🎤 Стендап
- 🖼 Выставки
- 🎭 Театр
- 🎬 Кино
- ⚽ Спорт
- 🚶 Экскурсии
- 🎪 Шоу
- 🔍 Квесты
- 🎓 Мастер-классы

### `/favorites`
Показать избранные события пользователя. Требует Redis для сохранения между сессиями.

### `/help`
Справка по командам бота.

---

## 🎛 Фильтры и функции

### 🔍 Фильтрация по датам

Доступные фильтры:
- **📅 Сегодня** - события на сегодняшний день
- **📅 Завтра** - события на завтра
- **📅 Неделя** - события на ближайшие 7 дней
- **📅 Месяц** - события на ближайший месяц

**Как использовать:**
1. Нажмите кнопку "⚙️ Фильтры" в главном меню или в списке событий
2. Выберите фильтр по дате
3. Список событий автоматически обновится

### 💰 Фильтрация по цене

Доступные фильтры:
- **💰 Бесплатно** - события с ценой 0₽
- **💰 До 500₽** - события от 1₽ до 500₽
- **💰 500-1500₽** - события от 501₽ до 1500₽
- **💰 1500-3000₽** - события от 1501₽ до 3000₽
- **💰 3000₽+** - события дороже 3000₽

**Как использовать:**
1. Нажмите кнопку "⚙️ Фильтры"
2. Выберите фильтр по цене
3. Список событий автоматически обновится

**Примечание:** Можно комбинировать фильтры (дата + цена + тип события)

### 📄 Пагинация

- События показываются по **5 на страницу**
- Кнопки **◀️ Назад** и **Вперед ▶️** для навигации
- Отображается текущая страница (например, "2/5")

**Как использовать:**
1. Просматривайте события по страницам
2. Используйте кнопки навигации для перехода между страницами

### ⭐ Избранное

Сохраняйте интересные события в избранное для быстрого доступа.

**Как добавить в избранное:**
1. Найдите интересующее событие
2. Нажмите кнопку **⭐ В избранное** под событием
3. Событие будет сохранено

**Как просмотреть избранное:**
- Команда `/favorites`
- Или кнопка "⭐ Избранное" в главном меню

**Как удалить из избранного:**
1. Откройте избранное
2. Нажмите кнопку **❌ Удалить из избранного** под событием

**Важно:**
- Избранное сохраняется в Redis (ключ `bot:favorites:{userId}`)
- Без Redis избранное работает только в рамках текущей сессии
- Каждый пользователь имеет свой список избранного

### 🔄 Сброс фильтров

Кнопка **🔄 Сбросить фильтры** возвращает список к исходному состоянию (все события, без фильтров).

---

## 📊 Источники данных

### 1. Локальные события (приоритет 1)

**Источник**: Local API (HTTP сервер в боте)

**Хранение**:
- В памяти (Map<string, Event>)
- В Redis (ключ `bot:local-events`) - если Redis доступен

**Особенности**:
- Добавляются через `POST /events` или `POST /events/batch`
- Всегда показываются первыми в списке
- Не дублируются с другими источниками (по UUID)

### 2. Gateway API (приоритет 2)

**Источник**: Основной бэкенд через Gateway

**Endpoints**:
- `GET /catalog/events` - все события
- `GET /catalog/events/{type}` - события по типу

**Кэширование**:
- Если Redis доступен: кэшируется с TTL (по умолчанию 30 минут)
- Ключи: `bot:events-cache:all`, `bot:events-cache:{type}`

**Fallback**: При ошибках используется моковые данные

### 3. Моковые данные (приоритет 3, fallback)

**Источник**: Встроенные в код (`src/data/mockEvents.ts`)

**Содержимое**: 5 тестовых событий разных типов

**Использование**:
- Когда `USE_MOCK_DATA=true`
- При ошибках Gateway API
- Когда других источников нет

---

## 📝 Формат данных события

```typescript
interface Event {
  id: number;                    // ID в БД
  uuid: string;                  // Уникальный UUID события
  source_id?: string;            // ID из источника
  title: string;                 // Название
  description: string;           // Описание
  price: number;                 // Цена (в рублях)
  date_preview: string;          // Дата для предпросмотра (ISO format)
  date_list: string[];           // Все даты проведения (ISO format)
  place: string;                 // Место проведения
  event_type: string;            // Тип: concert, theater, и т.д.
  genre: string;                 // Жанр
  age?: string;                  // Возрастное ограничение (например "18+")
  image_url: string;             // URL изображения (любой публичный URL)
  url: string;                   // Ссылка на событие
  created_at: string;            // Дата создания (ISO format)
}
```

**Примечание про изображения**: 
- Бот может использовать изображения из любого источника (любой публичный URL)
- Основной бэкенд (scraperCatalog) использует S3 для хранения, но это опционально и только для удобства
- Бот просто показывает изображение по URL, не важно откуда он берется

---

## 🔍 Типы событий

Поддерживаемые типы:

- `concert` - Концерты
- `stand_up` - Стендап
- `exhibition` - Выставки
- `theater` - Театр
- `cinema` - Кино
- `sport` - Спорт
- `excursion` - Экскурсии
- `show` - Шоу
- `quest` - Квесты
- `master_class` - Мастер-классы

---

## 🐛 Режим отладки

Для включения подробного логирования добавьте в `bot/.env`:

```env
DEBUG=true
```

В режиме отладки будут логироваться:
- Все входящие сообщения и callback_query
- Все запросы к API (Gateway, Redis, Local API)
- Все операции с событиями (получение, кэширование, объединение)
- Фильтрация и пагинация
- Операции с избранным
- Ошибки с подробной информацией

Пример вывода в debug режиме:
```
[INFO] Debug mode: ENABLED
[DEBUG] Received message: { chatId: 123, text: '/events', from: 'username' }
[DEBUG] Fetching events from Gateway API
[DEBUG] Found 10 cached events (type: concert)
[DEBUG] Applied date filter: today, events after filter: 3
[DEBUG] Applied price filter: cheap, events after filter: 2
[DEBUG] Showing page 1/2 (5 events per page)
[DEBUG] Sent 5 events to chat 123
```

---

## ❗ Частые проблемы

### Бот не отвечает на команды

**Решение**:
1. Проверьте токен в `bot/.env`: `TELEGRAM_BOT_TOKEN`
2. Проверьте логи: `docker compose logs bot`
3. Убедитесь, что бот запущен: `docker compose ps bot`
4. Попробуйте перезапустить: `docker compose restart bot`

### Ошибка "Gateway unavailable"

**Решение**:
- Бот автоматически переключится на моковые данные
- Убедитесь, что `USE_MOCK_DATA=true` или добавьте события через Local API
- Проверьте `GATEWAY_URL` в `.env`

### Локальные события пропали после перезапуска

**Решение**:
- Это нормально, если Redis недоступен (события хранятся только в памяти)
- Чтобы сохранить события, добавьте `REDIS_URL=redis://redis:6379` в `.env`
- После этого события будут сохраняться в Redis

### Избранное пропало после перезапуска

**Решение**:
- Избранное требует Redis для сохранения между сессиями
- Без Redis избранное работает только в рамках текущей сессии
- Добавьте `REDIS_URL=redis://redis:6379` в `.env` для персистентности

### Ошибка подключения к Redis

**Решение**:
- Бот будет работать без Redis (просто без кэширования и избранного)
- Проверьте, что Redis запущен: `docker compose ps redis`
- Проверьте URL: `redis://redis:6379` (имя сервиса из docker-compose.yaml)

### Port 3001 already in use

**Решение**:
- Измените порт в `.env`: `LOCAL_API_PORT=3002`
- Или остановите процесс, использующий порт

### Кнопки не работают

**Решение**:
1. Проверьте логи с `DEBUG=true` для диагностики
2. Убедитесь, что используется актуальная версия бота
3. Попробуйте перезапустить бота
4. Проверьте, что callback_query обрабатываются (см. логи)

---

## 🧪 Тестирование

### Проверка здоровья Local API

```bash
curl http://localhost:3001/health
```

### Добавление тестового события

```bash
curl -X POST http://localhost:3001/events \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "test-123",
    "title": "Тестовое событие",
    "event_type": "concert",
    "description": "Описание",
    "price": 1000,
    "date_preview": "2024-12-25T18:00:00",
    "date_list": ["2024-12-25T18:00:00"],
    "place": "Тестовое место",
    "genre": "test",
    "age": "18+",
    "image_url": "https://via.placeholder.com/800",
    "url": "https://example.com"
  }'
```

### Проверка добавленных событий

```bash
curl http://localhost:3001/events
```

### Проверка в боте

1. Откройте бота в Telegram
2. Отправьте `/events`
3. Должно появиться добавленное событие
4. Попробуйте фильтры: нажмите "⚙️ Фильтры" и выберите фильтр по дате или цене
5. Попробуйте пагинацию: если событий больше 5, появятся кнопки навигации
6. Попробуйте избранное: нажмите "⭐ В избранное" под событием, затем `/favorites`

---
